<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#071029;
  --muted:#f7f9fa;
  --accent:#f7f9fa;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Inter,Arial;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 34px;
  background:#020617;
  border-radius:10px;
  border:1px solid #ffffff;
}

header img{height:70px;}
header .title{font-size:30px;font-weight:700;color:var(--accent);}
header .clock{font-size:26px;font-weight:700;color:var(--muted);}

main{
  padding:12px;
  height:calc(100vh - 92px);
  display:grid;
  grid-template-columns: 1fr 2fr;
  gap:10px;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:12px;
  overflow:auto;
}

.card h2{
  margin:0 0 8px;
  color:var(--accent);
  font-size:26px;
  text-align:center;
}

.filter{
  text-align:center;
  margin-bottom:10px;
}
select{
  padding:6px 12px;
  font-size:16px;
  border-radius:6px;
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
}

.month-card{
  background:#2c4078;
  border-radius:10px;
  padding:12px;
  text-align:center;
  cursor:pointer;
  border:1px solid white;
  transition:.2s;
}
.month-card:hover{
  background:#3f5fc4;
}

.month-card .month{font-size:18px;font-weight:700;}
.month-card .year{font-size:14px;opacity:.8;}
.month-card .icon{font-size:28px;margin-top:6px;}

iframe{
  width:100%;
  height:100%;
  border:none;
  border-radius:10px;
  background:white;
}

.small{
  text-align:center;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>

<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">RELAT√ìRIOS DE UTILIZA√á√ÉO DE VE√çCULOS</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>RUV</h2>

    <div class="filter">
      Ano:
      <select id="yearFilter"></select>
    </div>

    <div id="cards" class="cards"></div>
  </section>

  <section class="card">
    <h2>Relat√≥rio</h2>
    <iframe id="viewer"></iframe>
  </section>
</main>

<div class="small">Atualiza√ß√£o autom√°tica ‚Ä¢ Google Sheets</div>

<script>
const SHEET_ID = "14mcVYMSc2HOSdb9N0Ykbs7KXBwLb8EwvGicF1GxnChQ";
const TAB_NAME = "RUV";

function updateClock(){
  const n = new Date();
  document.getElementById("clock").innerText =
    n.toLocaleDateString("pt-BR")+" ‚Äî "+
    n.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000);
updateClock();

const parseGviz = t =>
  JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));

const formatCell = c =>
  c == null ? "" : (typeof c === "object" ? (c.f ?? c.v ?? "") : String(c));

async function fetchSheet(){
  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`+
    `?sheet=${encodeURIComponent(TAB_NAME)}&tqx=out:json&nocache=${Date.now()}`;

  const r = await fetch(url,{cache:"no-store"});
  return parseGviz(await r.text());
}

let allData=[];

function getMonthIndex(m){
  if(!m) return -1;
  const clean = m.toString().trim().toLowerCase();
  const months = ["janeiro","fevereiro","mar√ßo","abril","maio","junho",
                  "julho","agosto","setembro","outubro","novembro","dezembro"];
  return months.indexOf(clean);
}

function sortData(){
  allData.sort((a,b)=>{
    if(a.ano!=b.ano) return b.ano - a.ano;
    return a.mesIndex - b.mesIndex;
  });
}

function renderFilter(){
  const years=[...new Set(allData.map(d=>d.ano))];
  const sel=document.getElementById("yearFilter");
  sel.innerHTML=`<option value="all">Todos</option>`;
  years.forEach(y=>{
    sel.innerHTML+=`<option value="${y}">${y}</option>`;
  });
  sel.onchange=renderCards;
}

function renderCards(){
  const year=document.getElementById("yearFilter").value;
  const box=document.getElementById("cards");
  box.innerHTML="";

  allData
    .filter(d=>year=="all"||d.ano==year)
    .forEach(d=>{
      box.innerHTML+=`
        <div class="month-card" onclick="openReport('${d.link}')">
          <div class="month">${d.mes}</div>
          <div class="year">${d.ano}</div>
          <div class="icon">üîó</div>
        </div>
      `;
    });
}

function openReport(link){
  document.getElementById("viewer").src=link;
}

async function load(){
  const g=await fetchSheet();
  const rows = (g.table.rows || []).filter(r=>{
    const c = r.c || [];
    return c[0] && !isNaN(c[0].v); // remove cabe√ßalho
  });

  allData=rows.map(r=>{
    const c=r.c||[];
    return {
      ano:formatCell(c[0]),
      mes:formatCell(c[1]),
      mesIndex:getMonthIndex(formatCell(c[1])),
      link:formatCell(c[2])
    };
  });

  sortData();
  renderFilter();
  renderCards();
}

load();
setInterval(load,30000);
</script>

</body>
</html>
